<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Contact Admin - Inbox & Trash</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    header { display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; font-size:20px; }
    .tabs { margin-top:20px; display:flex; gap:8px; }
    .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:#eee; }
    .tab.active { background:#007bff; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { padding:8px; border:1px solid #ddd; text-align:left; vertical-align:top; }
    .actions button { margin-right:6px; }
    .small { font-size:12px; color:#666; }
    .danger { background:#dc3545; color:#fff; border:none; padding:6px 8px; border-radius:4px; cursor:pointer; }
    .primary { background:#007bff; color:#fff; border:none; padding:6px 8px; border-radius:4px; cursor:pointer; }
    .muted { background:#6c757d; color:#fff; border:none; padding:6px 8px; border-radius:4px; cursor:pointer; }
    #messageForm { margin-top:24px; padding:12px; border:1px solid #ddd; border-radius:8px; background:#fafafa;}
    input, textarea { width:100%; padding:8px; margin-top:6px; margin-bottom:10px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc;}
  </style>
</head>
<body>
  <header>
    <h1>Contact Admin â€” Inbox</h1>
    <div class="small">Server API endpoints: <code>/api/messages</code></div>
  </header>

  <div class="tabs">
    <div id="tab-inbox" class="tab active" onclick="showTab('inbox')">Inbox</div>
    <div id="tab-trash" class="tab" onclick="showTab('trash')">Trash</div>
    <div id="tab-new" class="tab" onclick="showTab('new')">Send Test Message</div>
  </div>

  <div id="content-inbox">
    <table id="inbox-table" aria-live="polite">
      <thead>
        <tr><th>From</th><th>Subject / Message</th><th>Received</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="content-trash" style="display:none;">
    <table id="trash-table">
      <thead>
        <tr><th>From</th><th>Subject / Message</th><th>Deleted At</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="content-new" style="display:none;">
    <div id="messageForm">
      <h3>Send test message (saves to DB)</h3>
      <input id="name" placeholder="Your name" />
      <input id="email" placeholder="Email (optional)" />
      <input id="subject" placeholder="Subject (optional)" />
      <textarea id="message" placeholder="Message" rows="6"></textarea>
      <button class="primary" onclick="sendTestMessage()">Send</button>
    </div>
  </div>

  <script>
    const API_BASE = '/api/messages'; // server serves on same origin
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('content-inbox').style.display = (tab==='inbox') ? '' : 'none';
      document.getElementById('content-trash').style.display = (tab==='trash') ? '' : 'none';
      document.getElementById('content-new').style.display = (tab==='new') ? '' : 'none';
      if (tab === 'inbox') loadMessages();
      if (tab === 'trash') loadDeletedMessages();
    }

    async function loadMessages() {
      try {
        const res = await fetch(API_BASE);
        const msgs = await res.json();
        const tbody = document.querySelector('#inbox-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(msgs) || msgs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="small">No messages</td></tr>';
          return;
        }
        msgs.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(m.name)}</strong><div class="small">${escapeHtml(m.email||'')}</div></td>
            <td><strong>${escapeHtml(m.subject||'')}</strong><div>${escapeHtml(m.message)}</div></td>
            <td class="small">${new Date(m.createdAt).toLocaleString()}</td>
            <td class="actions">
              <button class="muted" onclick="viewMessage('${m._id}')">View</button>
              <button class="danger" onclick="deleteMessage('${m._id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to load messages');
      }
    }

    async function loadDeletedMessages() {
      try {
        const res = await fetch(API_BASE + '/deleted');
        const msgs = await res.json();
        const tbody = document.querySelector('#trash-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(msgs) || msgs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="small">No deleted messages</td></tr>';
          return;
        }
        msgs.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(m.name)}</strong><div class="small">${escapeHtml(m.email||'')}</div></td>
            <td><strong>${escapeHtml(m.subject||'')}</strong><div>${escapeHtml(m.message)}</div></td>
            <td class="small">${m.deletedAt ? new Date(m.deletedAt).toLocaleString() : ''}</td>
            <td class="actions">
              <button class="primary" onclick="restoreMessage('${m._id}')">Restore</button>
              <button class="danger" onclick="permanentDelete('${m._id}')">Delete Permanently</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to load deleted messages');
      }
    }

    async function deleteMessage(id) {
      if (!confirm('Move this message to Trash?')) return;
      try {
        const res = await fetch(API_BASE + '/' + id, { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ admin: 'admin' }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Delete failed');
        alert('Message moved to Trash');
        loadMessages();
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    async function restoreMessage(id) {
      if (!confirm('Restore this message to Inbox?')) return;
      try {
        const res = await fetch(API_BASE + '/' + id + '/restore', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Restore failed');
        alert('Message restored');
        loadDeletedMessages();
        loadMessages();
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    async function permanentDelete(id) {
      if (!confirm('Permanently delete this message? This cannot be undone.')) return;
      try {
        const res = await fetch(API_BASE + '/' + id + '/permanent', { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Permanent delete failed');
        alert('Message permanently deleted');
        loadDeletedMessages();
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    function viewMessage(id) {
      // simple approach: open message details in prompt (or implement modal)
      alert('Open message details in developer tools or implement modal.');
    }

    // small helper and XSS safe escape
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // send a test message (contact form simulation)
    async function sendTestMessage() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const subject = document.getElementById('subject').value.trim();
      const message = document.getElementById('message').value.trim();
      if (!name || !message) return alert('Name and message required');
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, subject, message })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to send');
        alert('Message saved');
        document.getElementById('name').value='';
        document.getElementById('email').value='';
        document.getElementById('subject').value='';
        document.getElementById('message').value='';
        showTab('inbox');
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    // initial load
    loadMessages();
  </script>
</body>
</html>
